name: Test UI on Renovate PRs

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - "ui/**"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  check-author:
    runs-on: ubuntu-latest
    permissions: {}
    outputs:
      is_renovate: ${{ steps.check.outputs.is_renovate }}
    steps:
      - id: check
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          if [[ -z "$PR_AUTHOR" || "$PR_AUTHOR" == "renovate[bot]" ]]; then
            echo "is_renovate=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_renovate=false" >> "$GITHUB_OUTPUT"
          fi

  publish-images:
    needs: check-author
    if: needs.check-author.outputs.is_renovate == 'true'
    uses: NethServer/ns8-github-actions/.github/workflows/publish-branch.yml@v1
    permissions:
      packages: write
      actions: read
      contents: write

  module:
    needs: publish-images
    permissions: {}
    uses: NethServer/ns8-github-actions/.github/workflows/module-info.yml@v1

  run_ui_tests:
    needs: module
    permissions: {}
    uses: NethServer/ns8-github-actions/.github/workflows/test-on-digitalocean-infra.yml@v1
    with:
      script: test-ui.sh
      path: ui
      args: "ghcr.io/${{needs.module.outputs.owner}}/${{needs.module.outputs.name}}:${{needs.module.outputs.tag}}"
      repo_ref: ${{needs.module.outputs.sha}}
      debug_shell: false
    secrets:
      do_token: ${{ secrets.do_token }}
